<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Webhook Events</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .filter-container {
      margin-bottom: 10px;
    }
    .filter-container label {
      margin-right: 10px;
    }
    .filter-container select {
      margin-right: 20px;
    }
    .back-button {
      margin-bottom: 20px;
      padding: 10px 20px;
      font-size: 1rem;
      background-color: #00BCD4;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .delete-selected-button {
      margin-left: 20px;
      padding: 8px 16px;
      font-size: 0.9rem;
      background-color: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    /* 테이블 고정 레이아웃 + row 높이 고정 & 스크롤 */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      table-layout: fixed;
    }
    thead th {
      background: #f0f0f0;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      vertical-align: top;
      word-wrap: break-word;
    }
    tbody tr {
      height: 120px;
    }
    tbody td {
      overflow: auto;
    }
  </style>
</head>
<body>
  <!-- Back to Admin 버튼 -->
  <button class="back-button" onclick="window.location.href='admin.html'">Back to Admin</button>

  <h1>Webhook Events</h1>

  <!-- 필터 & 삭제 버튼들 -->
  <div class="filter-container">
    <label for="nonOrderExtraTagFilter">Filter by Extra Tag (Non-Order):</label>
    <select id="nonOrderExtraTagFilter">
      <option value="all">All</option>
    </select>

    <label for="orderIdFilter">Filter by Order ID:</label>
    <select id="orderIdFilter">
      <option value="all">All</option>
    </select>

    <button class="delete-selected-button" id="deleteSelectedBtn">Delete Selected</button>
  </div>

  <table id="eventsTable">
    <colgroup>
      <col style="width: 4%;">
      <col style="width: 9%;">
      <col style="width: 9%;">
      <col style="width: 9%;">
      <col style="width: 9%;">
      <col style="width: 9%;">
      <col style="width: 9%;">
      <col style="width: 9%;">
      <col style="width: 9%;">
      <col style="width: 9%;">
      <col style="width: 9%;">
      <col style="width: 9%;">
    </colgroup>
    <thead>
      <tr>
        <th>
          <input type="checkbox" id="selectAllCheckbox" />
        </th>
        <th>Received At</th>
        <th>Extra Tag</th>
        <th>Email</th>
        <th>Sent</th>
        <th>Opened</th>
        <th>Clicked</th>
        <th>Unsubscribed</th>
        <th>Complaints</th>
        <th>Bounce/Error</th>
        <th>Other Info</th>
        <th>ID</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let allEvents = [];

    // ExtraTag 파싱 함수: merge_extratag → extratag → headers 내 X-ExtraTag
    function getFinalExtraTag(data) {
      if (data.merge_extratag) return data.merge_extratag;
      if (data.extratag) return data.extratag;
      if (data.headers && typeof data.headers === 'string') {
        const lines = data.headers.split('\n');
        for (const line of lines) {
          if (line.trim().toLowerCase().startsWith('x-extratag:')) {
            return line.split(':')[1].trim();
          }
        }
      }
      return 'N/A';
    }

    async function fetchEvents() {
      try {
        const response = await fetch('/api/webhook-events');
        const result = await response.json();

        if (!result.success) {
          console.error('Failed to fetch events:', result);
          return;
        }

        allEvents = result.events;
        updateFilterOptions(allEvents);
        renderEvents();
      } catch (err) {
        console.error('Error fetching events:', err);
      }
    }

    function updateFilterOptions(events) {
      const nonOrderTagSet = new Set();
      const orderIdSet = new Set();

      events.forEach(event => {
        const data = event.data || {};
        const tag = getFinalExtraTag(data);
        if (/^\d{8}$/.test(tag)) {
          orderIdSet.add(tag);
        } else {
          nonOrderTagSet.add(tag);
        }
      });

      const nonOrderFilter = document.getElementById('nonOrderExtraTagFilter');
      const orderIdFilter = document.getElementById('orderIdFilter');

      while (nonOrderFilter.options.length > 1) {
        nonOrderFilter.remove(1);
      }
      while (orderIdFilter.options.length > 1) {
        orderIdFilter.remove(1);
      }

      nonOrderTagSet.forEach(tag => {
        const option = document.createElement('option');
        option.value = tag;
        option.textContent = tag;
        nonOrderFilter.appendChild(option);
      });

      orderIdSet.forEach(tag => {
        const option = document.createElement('option');
        option.value = tag;
        option.textContent = tag;
        orderIdFilter.appendChild(option);
      });
    }

    function renderEvents() {
      const nonOrderFilter = document.getElementById('nonOrderExtraTagFilter');
      const orderIdFilter = document.getElementById('orderIdFilter');
      const nonOrderSelected = nonOrderFilter.value;
      const orderSelected = orderIdFilter.value;

      const filtered = allEvents.filter(event => {
        const data = event.data || {};
        const finalTag = getFinalExtraTag(data);
        if (nonOrderSelected === 'all' && orderSelected === 'all') return true;
        if (nonOrderSelected !== 'all' && finalTag === nonOrderSelected) return true;
        if (orderSelected !== 'all' && finalTag === orderSelected) return true;
        return false;
      });

      const tbody = document.querySelector('#eventsTable tbody');
      tbody.innerHTML = '';

      filtered.forEach(event => {
        const eventId = event._id;
        const data = event.data || {};
        const { to, from, status, messageid, ...rest } = data;
        const eventType = (event.eventType || "").toLowerCase();
        const finalExtraTag = getFinalExtraTag(data);

        const row = document.createElement('tr');

        // 체크박스
        const checkboxCell = document.createElement('td');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'row-checkbox';
        checkbox.value = eventId;
        checkboxCell.appendChild(checkbox);
        row.appendChild(checkboxCell);

        // Received At
        const receivedCell = document.createElement('td');
        receivedCell.textContent = new Date(event.receivedAt).toLocaleString();
        row.appendChild(receivedCell);

        // Extra Tag
        const tagCell = document.createElement('td');
        tagCell.textContent = finalExtraTag;
        row.appendChild(tagCell);

        // Email
        const emailCell = document.createElement('td');
        emailCell.textContent = to || 'N/A';
        row.appendChild(emailCell);

        // Sent
        const sentCell = document.createElement('td');
        sentCell.textContent = (eventType === 'sent' || status === 'Sent') ? '✓' : '';
        row.appendChild(sentCell);

        // Opened
        const openedCell = document.createElement('td');
        openedCell.textContent = (eventType === 'opened' || status === 'Opened') ? '✓' : '';
        row.appendChild(openedCell);

        // Clicked
        const clickedCell = document.createElement('td');
        clickedCell.textContent = (eventType === 'clicked') ? '✓' : '';
        row.appendChild(clickedCell);

        // Unsubscribed
        const unsubCell = document.createElement('td');
        unsubCell.textContent = (eventType === 'unsubscribed') ? '✓' : '';
        row.appendChild(unsubCell);

        // Complaints
        const complaintCell = document.createElement('td');
        complaintCell.textContent = (eventType === 'complaint' || eventType === 'spamreport') ? '✓' : '';
        row.appendChild(complaintCell);

        // Bounce/Error
        const bounceCell = document.createElement('td');
        bounceCell.textContent = (["bounce", "error", "failed"].includes(eventType)) ? '✓' : '';
        row.appendChild(bounceCell);

        // Other Info: 각 key-value 쌍으로 분리하여 줄바꿈 처리
        const otherInfoCell = document.createElement('td');
        let infoHTML = "";
        Object.entries(rest).forEach(([key, value]) => {
          infoHTML += `<strong>${key}</strong>: ${value}<br>`;
        });
        otherInfoCell.innerHTML = infoHTML;
        row.appendChild(otherInfoCell);

        // ID (messageid)
        const idCell = document.createElement('td');
        idCell.textContent = messageid || 'N/A';
        row.appendChild(idCell);

        tbody.appendChild(row);
      });
    }

    async function deleteSelectedEvents() {
      const checkboxes = document.querySelectorAll('.row-checkbox:checked');
      if (!checkboxes.length) {
        alert('No events selected for deletion.');
        return;
      }
      if (!confirm(`Delete ${checkboxes.length} selected event(s)?`)) return;

      const idsToDelete = Array.from(checkboxes).map(cb => cb.value);

      try {
        const resp = await fetch('/api/webhook-events/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: idsToDelete })
        });
        const result = await resp.json();
        if (result.success) {
          alert('Deleted successfully!');
          fetchEvents();
        } else {
          alert('Failed to delete: ' + (result.message || 'Unknown error'));
        }
      } catch (err) {
        console.error('Error deleting selected events:', err);
      }
    }

    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAllCheckbox').checked;
      const checkboxes = document.querySelectorAll('.row-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = selectAll;
      });
    }

    document.getElementById('selectAllCheckbox').addEventListener('change', toggleSelectAll);
    document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelectedEvents);
    document.getElementById('nonOrderExtraTagFilter').addEventListener('change', renderEvents);
    document.getElementById('orderIdFilter').addEventListener('change', renderEvents);

    fetchEvents();
  </script>
</body>
</html>