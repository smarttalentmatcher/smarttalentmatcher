<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Webhook Events</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .filter-container {
      margin-bottom: 10px;
    }
    .filter-container label {
      margin-right: 10px;
    }
    .filter-container select {
      margin-right: 20px;
    }
    .back-button {
      margin-bottom: 20px;
      padding: 10px 20px;
      font-size: 1rem;
      background-color: #00BCD4;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .delete-selected-button {
      margin-left: 20px;
      padding: 8px 16px;
      font-size: 0.9rem;
      background-color: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      table-layout: fixed;
    }
    thead th {
      background: #f0f0f0;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      vertical-align: top;
      word-wrap: break-word;
    }
    tbody tr {
      height: 120px;
    }
    tbody td {
      overflow: auto;
    }
  </style>
</head>
<body>
  <!-- Back to Admin 버튼 -->
  <button class="back-button" onclick="window.location.href='admin.html'">Back to Admin</button>

  <h1>Webhook Events</h1>

  <!-- 필터 & 삭제 버튼들 (여기서는 Category 기준 필터) -->
  <div class="filter-container">
    <label for="categoryFilter">Filter by Category:</label>
    <select id="categoryFilter">
      <option value="all">All</option>
    </select>
    <button class="delete-selected-button" id="deleteSelectedBtn">Delete Selected</button>
  </div>

  <table id="eventsTable">
    <colgroup>
      <col style="width: 4%;">
      <col style="width: 8%;">
      <col style="width: 8%;">
      <col style="width: 8%;">
      <col style="width: 8%;">
      <col style="width: 8%;">
      <col style="width: 8%;">
      <col style="width: 8%;">
      <col style="width: 8%;">
      <col style="width: 8%;">
      <col style="width: 8%;">
      <col style="width: 8%;">
      <col style="width: 8%;">
      <col style="width: 8%;">
    </colgroup>
    <thead>
      <tr>
        <th>
          <input type="checkbox" id="selectAllCheckbox" />
        </th>
        <th>Date</th>
        <th>Category</th>
        <th>Account</th>
        <th>Subject</th>
        <th>Sent</th>
        <th>Opened</th>
        <th>Clicked</th>
        <th>Unsubscribed</th>
        <th>Complaints</th>
        <th>Bounce/Error</th>
        <th>Transaction</th>
        <th>Channel</th>
        <th>ID</th>
        <th>Other Info</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let allEvents = [];

    // ExtraTag 파싱 함수 (여기서는 X-ExtraTag 관련은 사용하지 않고, category 필드 사용)
    function getFinalCategory(data) {
      // 우선, Elastic Email에서 전송된 category 필드를 사용
      if (data.category) return data.category;
      // fallback: merge_extratag 또는 extratag 사용
      if (data.merge_extratag) return data.merge_extratag;
      if (data.extratag) return data.extratag;
      // headers 내 X-ExtraTag 확인 (대소문자 무시)
      if (data.headers && typeof data.headers === 'string') {
        const lines = data.headers.split('\n');
        for (const line of lines) {
          if (line.trim().toLowerCase().startsWith('x-extratag:')) {
            return line.split(':')[1].trim();
          }
        }
      }
      return 'N/A';
    }

    async function fetchEvents() {
      try {
        const response = await fetch('/api/webhook-events');
        const result = await response.json();
        if (!result.success) {
          console.error('Failed to fetch events:', result);
          return;
        }
        allEvents = result.events;
        updateFilterOptions(allEvents);
        renderEvents();
      } catch (err) {
        console.error('Error fetching events:', err);
      }
    }

    // 여기서는 필터 옵션은 category 기준으로 설정
    function updateFilterOptions(events) {
      const categorySet = new Set();
      events.forEach(event => {
        const data = event.data || {};
        const cat = data.category || getFinalCategory(data);
        categorySet.add(cat);
      });
      const categoryFilter = document.getElementById('categoryFilter');
      while (categoryFilter.options.length > 1) {
        categoryFilter.remove(1);
      }
      categorySet.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        categoryFilter.appendChild(option);
      });
    }

    function renderEvents() {
      const categoryFilter = document.getElementById('categoryFilter');
      const selectedCategory = categoryFilter.value;
      
      const filtered = allEvents.filter(event => {
        const data = event.data || {};
        const cat = data.category || getFinalCategory(data);
        if (selectedCategory === 'all') return true;
        return cat === selectedCategory;
      });

      const tbody = document.querySelector('#eventsTable tbody');
      tbody.innerHTML = '';

      // Other Info에서 중복을 피할 필드 목록
      const excludedKeys = ['date', 'category', 'account', 'subject', 'transaction', 'channel', 'messageid', 'status', 'merge_extratag', 'extratag', 'event'];

      filtered.forEach(event => {
        const eventId = event._id;
        const data = event.data || {};

        // 각 열의 데이터 (없으면 fallback 처리)
        const dateField = data.date || new Date(event.receivedAt).toLocaleString();
        const categoryField = data.category || getFinalCategory(data);
        const accountField = data.account || 'N/A';
        const subjectField = data.subject || 'N/A';
        const transactionField = data.transaction || 'N/A';
        const channelField = data.channel || 'N/A';
        const idField = data.messageid || 'N/A';

        // 이벤트 타입 처리
        const eventType = (event.eventType || "").toLowerCase();
        const sentVal = (eventType === 'sent' || data.status === 'Sent') ? '✓' : '';
        const openedVal = (eventType === 'opened' || data.status === 'Opened') ? '✓' : '';
        const clickedVal = (eventType === 'clicked') ? '✓' : '';
        const unsubVal = (eventType === 'unsubscribed') ? '✓' : '';
        const complaintVal = (eventType === 'complaint' || eventType === 'spamreport') ? '✓' : '';
        const bounceVal = (["bounce", "error", "failed"].includes(eventType)) ? '✓' : '';

        // Other Info: 나머지 필드 중, excludedKeys에 없는 값들만 출력
        let otherInfoHTML = "";
        Object.entries(data).forEach(([key, value]) => {
          if (!excludedKeys.includes(key.toLowerCase())) {
            otherInfoHTML += `<strong>${key}</strong>: ${value}<br>`;
          }
        });

        const row = document.createElement('tr');

        // 체크박스
        const checkboxCell = document.createElement('td');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'row-checkbox';
        checkbox.value = eventId;
        checkboxCell.appendChild(checkbox);
        row.appendChild(checkboxCell);

        // 각 열 생성
        const dateCell = document.createElement('td');
        dateCell.textContent = dateField;
        row.appendChild(dateCell);

        const categoryCell = document.createElement('td');
        categoryCell.textContent = categoryField;
        row.appendChild(categoryCell);

        const accountCell = document.createElement('td');
        accountCell.textContent = accountField;
        row.appendChild(accountCell);

        const subjectCell = document.createElement('td');
        subjectCell.textContent = subjectField;
        row.appendChild(subjectCell);

        const sentCell = document.createElement('td');
        sentCell.textContent = sentVal;
        row.appendChild(sentCell);

        const openedCell = document.createElement('td');
        openedCell.textContent = openedVal;
        row.appendChild(openedCell);

        const clickedCell = document.createElement('td');
        clickedCell.textContent = clickedVal;
        row.appendChild(clickedCell);

        const unsubCell = document.createElement('td');
        unsubCell.textContent = unsubVal;
        row.appendChild(unsubCell);

        const complaintCell = document.createElement('td');
        complaintCell.textContent = complaintVal;
        row.appendChild(complaintCell);

        const bounceCell = document.createElement('td');
        bounceCell.textContent = bounceVal;
        row.appendChild(bounceCell);

        const transactionCell = document.createElement('td');
        transactionCell.textContent = transactionField;
        row.appendChild(transactionCell);

        const channelCell = document.createElement('td');
        channelCell.textContent = channelField;
        row.appendChild(channelCell);

        const idCell = document.createElement('td');
        idCell.textContent = idField;
        row.appendChild(idCell);

        const otherInfoCell = document.createElement('td');
        otherInfoCell.innerHTML = otherInfoHTML;
        row.appendChild(otherInfoCell);

        tbody.appendChild(row);
      });
    }

    async function deleteSelectedEvents() {
      const checkboxes = document.querySelectorAll('.row-checkbox:checked');
      if (!checkboxes.length) {
        alert('No events selected for deletion.');
        return;
      }
      if (!confirm(`Delete ${checkboxes.length} selected event(s)?`)) return;
      const idsToDelete = Array.from(checkboxes).map(cb => cb.value);
      try {
        const resp = await fetch('/api/webhook-events/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: idsToDelete })
        });
        const result = await resp.json();
        if (result.success) {
          alert('Deleted successfully!');
          fetchEvents();
        } else {
          alert('Failed to delete: ' + (result.message || 'Unknown error'));
        }
      } catch (err) {
        console.error('Error deleting selected events:', err);
      }
    }

    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAllCheckbox').checked;
      const checkboxes = document.querySelectorAll('.row-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = selectAll;
      });
    }

    document.getElementById('selectAllCheckbox').addEventListener('change', toggleSelectAll);
    document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelectedEvents);
    document.getElementById('nonOrderExtraTagFilter').addEventListener('change', renderEvents);
    document.getElementById('orderIdFilter').addEventListener('change', renderEvents);

    fetchEvents();
  </script>
</body>
</html>