<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - Orders</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .orders-container {
      width: 90%;
      max-width: 1800px;
      margin: 40px auto;
      max-height: 250px;
      overflow-y: auto;
    }
    .orders-table {
      width: 100%;
      border-collapse: collapse;
      margin: 0 auto;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-radius: 8px;
      table-layout: fixed; /* 고정 레이아웃: colgroup의 너비를 강제 적용 */
    }
    .orders-table th, .orders-table td {
      padding: 10px 8px;
      border: 1px solid #ccc;
      text-align: center;
      font-size: 0.95rem;
      vertical-align: top;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    .orders-table th {
      background-color: #FFFF00;
      color: #000;
      font-weight: bold;
    }
    .delete-button {
      background-color: red;
      color: #fff;
      border: none;
      cursor: pointer;
      margin-top: 5px;
      padding: 6px 10px;
      border-radius: 4px;
    }
    /* Invoice 셀의 내용이 넘칠 경우 가로 스크롤 생성 */
    .scroll-cell {
      overflow-x: auto;
      word-wrap: break-word;
    }
    .filter-container {
      text-align: center;
      margin-bottom: 20px;
    }
    .filter-container select {
      padding: 8px;
      margin: 5px;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <header class="admin-header">
    <h1>Admin Panel - Orders</h1>
  </header>

  <!-- 필터 (검색창 제거됨) -->
  <div class="filter-container">
    <select id="filter-status">
      <option value="all">All Orders</option>
      <option value="expired">24hrs Passed</option>
      <option value="paid">Paid Orders</option>
      <option value="unpaid">Unpaid Orders</option>
      <option value="3weeks">Services Started Over 3 Weeks Ago</option>
    </select>
  </div>

  <div class="orders-container">
    <table class="orders-table">
      <!-- colgroup 적용: 각 열의 너비를 지정 -->
      <colgroup>
        <!-- 1. Order ID: 200px -->
        <col style="width: 200px;">
        <!-- 2. Venmo Account: 200px -->
        <col style="width: 200px;">
        <!-- 3. Email Address: 200px -->
        <col style="width: 200px;">
        <!-- 4. Email Subject: 200px -->
        <col style="width: 200px;">
        <!-- 5. Acting Reel: 200px -->
        <col style="width: 200px;">
        <!-- 6. Resume Link: 200px -->
        <col style="width: 200px;">
        <!-- 7. Introduction: 200px -->
        <col style="width: 200px;">
        <!-- 8. Headshot: 200px -->
        <col style="width: 200px;">
        <!-- 9. Invoice: 400px (나머지 열과 다르게 더 넓게) -->
        <col style="width: 400px;">
        <!-- 10. Payment / Delete: 200px -->
        <col style="width: 200px;">
      </colgroup>
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Venmo Account</th>
          <th>Email Address</th>
          <th>Email Subject</th>
          <th>Acting Reel</th>
          <th>Resume Link</th>
          <th>Introduction</th>
          <th>Headshot</th>
          <th>Invoice</th>
          <th>Payment / Delete</th>
        </tr>
      </thead>
      <tbody id="orders-tbody">
        <!-- 주문 데이터가 동적으로 추가됩니다 -->
      </tbody>
    </table>
  </div>

  <script>
    let ordersData = [];

    // 주문 데이터 불러오기
    fetch('/admin/orders')
      .then(response => response.json())
      .then(orders => {
        ordersData = orders;
        renderOrders(orders);
      })
      .catch(error => {
        console.error("Error fetching orders:", error);
        document.getElementById('orders-tbody').innerHTML = "<tr><td colspan='10'>Failed to load orders.</td></tr>";
      });

    function renderOrders(orders) {
      const tbody = document.getElementById('orders-tbody');
      tbody.innerHTML = "";

      orders.forEach(order => {
        const tr = document.createElement('tr');
        const timeSinceCreation = Date.now() - new Date(order.createdAt).getTime();
        const isExpired = timeSinceCreation >= 24 * 60 * 60 * 1000;
        // 주문 정보 추가 (특정 필드만 사용)
        ["orderId", "venmoId", "emailAddress", "emailSubject", "actingReel", "resumeLink", "introduction"].forEach(field => {
          const td = document.createElement('td');
          td.textContent = order[field] || "";
          tr.appendChild(td);
        });

        // Headshot (이미지)
        const headshotTd = document.createElement('td');
        if (order.headshot) {
          const img = document.createElement('img');
          img.src = order.headshot;
          img.alt = "Headshot Preview";
          img.style.width = "100px";
          headshotTd.appendChild(img);
        } else {
          headshotTd.textContent = "N/A";
        }
        tr.appendChild(headshotTd);

        // Invoice (가로 폭은 colgroup에 의해 400px 고정, 내용이 넘치면 가로 스크롤)
        const invoiceTd = document.createElement('td');
        invoiceTd.classList.add("scroll-cell");
        invoiceTd.innerHTML = order.invoice || "";
        tr.appendChild(invoiceTd);

        // Payment / Delete
        const paymentTd = document.createElement('td');
        if (timeSinceCreation >= 48 * 60 * 60 * 1000) {
          tr.remove(); // 48시간 지난 주문 삭제
          return; // 다음 주문으로 넘어감
        } else if (isExpired) {
          paymentTd.innerHTML = `<span style="color:red; font-weight:bold;">24hrs</span>`;
        } else {
          let finalCost = order.finalCost || "";
          if (finalCost !== "") {
            finalCost = "$" + parseFloat(finalCost).toFixed(2);
          }
          const checkedAttr = order.paid ? "checked" : "";
          paymentTd.innerHTML = `
            ${finalCost}
            <br>
            <label>
              <input type="checkbox" class="payment-checkbox" data-order-id="${order.orderId}" ${checkedAttr}>
              Paid
            </label>
            <br>
            <button class="delete-button" data-order-id="${order.orderId}">Delete</button>
          `;
        }
        tr.appendChild(paymentTd);
        tbody.appendChild(tr);
      });
      
      // 체크박스 이벤트 핸들러 연결
      attachPaymentCheckboxHandlers();
    }

    function attachPaymentCheckboxHandlers() {
      const checkboxes = document.querySelectorAll('.payment-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const orderId = this.dataset.orderId;
          const paid = this.checked;
          // 체크박스 변경 시 GET 요청으로 결제 상태 업데이트
          fetch(`/admin/toggle-payment?orderId=${orderId}&paid=${paid}`, { method: 'GET' })
            .then(response => response.json())
            .then(data => {
              console.log(data.message);
              // 만약 결제 상태가 true라면, update-payment 엔드포인트를 호출하여 이메일 발송 및 추가 처리를 진행
              if (paid) {
                fetch('/admin/update-payment', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ orderId, paid })
                })
                .then(response => response.json())
                .then(result => {
                  console.log(result.message);
                })
                .catch(err => {
                  console.error("Error in update-payment:", err);
                });
              }
            })
            .catch(error => {
              console.error("Error updating payment:", error);
            });
        });
      });
    }

    // 필터 기능
    document.getElementById("filter-status").addEventListener("change", function () {
      const filter = this.value;
      const now = Date.now();
      const filteredOrders = ordersData.filter(order => {
        const timeSinceCreation = now - new Date(order.createdAt).getTime();
        if (filter === "expired") return timeSinceCreation >= 24 * 60 * 60 * 1000;
        if (filter === "paid") return order.paid;
        if (filter === "unpaid") return !order.paid;
        if (filter === "3weeks") return timeSinceCreation >= 21 * 24 * 60 * 60 * 1000;
        return true;
      });
      renderOrders(filteredOrders);
    });
  </script>
</body>
</html>